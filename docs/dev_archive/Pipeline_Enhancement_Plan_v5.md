# 📋 파이프라인 고도화 계획서 (v5.1)

## 📌 개요
현재의 블라인드 인덱싱 과정을 **사용자 확인 가능한 4단계 파이프라인**으로 개편하여, 메타데이터 품질을 높이고 대량 작업 시 안정성을 확보함.

### 🎯 v5.1 주요 변경사항
- **시맨틱 청킹 옵션**: LLM 기반 논리 단위 분리 지원
- **Dual-Mode 전략**: 배포용(Streamlit) / 개발자용(IDE) 분리
- **주제 태그 필드**: 복수 주제 교차 검색 지원
- **완료 대시보드**: 세션 종료 시 통계 요약

---

## 🔷 1단계: 텍스트 추출 (내부 처리)

**변경 없음** - 현재 로직 유지
- **프로세스**: 파일 업로드 → OCR/텍스트 추출 → staging 저장
- **특징**: 사용자 개입 불필요, 백그라운드 처리

---

## 🔷 2단계: 청킹 + 메타데이터 입력 (핵심 고도화)

### 2.1 UI 레이아웃 설계

```text
┌─────────────────────────────────────────────────────────────────┐
│ 📚 청킹 대기열 (3개 파일)                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌─ [1/3] Michael Welker - In God's Image (2021).epub ──────────┐│
│ │                                                              ││
│ │  📄 추출된 텍스트: 45,230자 | 예상 청크: ~107개              ││
│ │                                                              ││
│ │  ───── 필수 메타데이터 ─────                                  ││
│ │  저자명:     [Michael Welker        ] (자동 추출)            ││
│ │  출판연도:   [2021                  ] (자동 추출)            ││
│ │  도서제목:   [In God's Image        ] (자동 추출)            ││
│ │                                                              ││
│ │  ───── 분류 메타데이터 ─────                                  ││
│ │  도서 유형:  ◉ 교의학  ○ 사전  ○ 주석  ○ 철학  ○ 기타      ││
│ │  주요 언어:  ☑ 영어  ☐ 독일어  ☐ 한국어  ☐ 라틴어          ││
│ │  신학 분야:  [조직신학 ▼] (드롭다운)                         ││
│ │                                                              ││
│ │  ───── 고급 옵션 ─────                                        ││
│ │  청크 사이즈: [1200] 토큰  (교의학 추천: 1200 / 사전: 400)   ││
│ │  오버랩:      [150] 토큰                                     ││
│ │                                                              ││
│ │  [미리보기] [청킹 실행 ▶]                                    ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ┌─ [2/3] Barth_KD_I_1.pdf ─────────────────────────────────────┐│
│ │  (대기 중...)                                                 ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ┌─ [3/3] TDNT_Vol1.pdf ────────────────────────────────────────┐│
│ │  (대기 중...)                                                 ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ════════════════════════════════════════════════════════════   │
│ 청킹 완료: 1/3                     [전체 임베딩 시작 ▶▶]        │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 메타데이터 필드 상세

| 필드명 | 타입 | 자동 추출 | 필수 | 설명 |
|--------|------|----------|------|------|
| **저자명** | text | ✅ 파일명 파싱 | ✅ | `Author - Title (Year)` 패턴 인식 |
| **출판연도** | number | ✅ 파일명 파싱 | ⬜ | 4자리 연도 추출 |
| **도서제목** | text | ✅ 파일명 파싱 | ✅ | 저자 제외 제목 |
| **도서 유형** | radio | ⬜ 키워드 기반 추천 | ✅ | 교의학/사전/주석/철학/기타 |
| **주요 언어** | checkbox | ⬜ 텍스트 분석 | ⬜ | 다중 선택 가능 (en, de, ko, etc.) |
| **신학 분야** | dropdown | ⬜ | ⬜ | 조직/역사/실천/성서 등 |
| **주제 태그** | multi-select | ⬜ | ⬜ | 복수 키워드 (칭의, 삼위일체, 인간론 등) |
| **청크 사이즈** | slider | ✅ 유형 기반 | ✅ | 400~2000 토큰 |
| **오버랩** | slider | ✅ | ⬜ | 50~300 토큰 |

### 2.3 자동 추출 로직 (파일명 파싱)

```python
# 지원 패턴 예시
1. "Author - Title (Year).ext"  → {author, title, year}
2. "Author_Title_Year.ext"      → {author, title, year}
3. "Title - Author.ext"         → {title, author}
4. 파싱 실패 시                 → 수동 입력 모드
```

### 2.4 도서 유형별 기본값 (Preset)

| 도서 유형 | 청크 사이즈 | 오버랩 | 설명 |
|-----------|------------|--------|------|
| **교의학** | 1200 | 150 | 넓은 문맥 유지 (논증 파악) |
| **사전** | 400 | 50 | 정밀 검색 최적화 (항목별) |
| **주석** | 600 | 80 | 성경 절/구 단위 해석 |
| **철학** | 1000 | 120 | 긴 호흡의 논증 흐름 유지 |
| **기타** | 800 | 100 | 범용 설정 |

### 2.5 청킹 미리보기 기능

- **목적**: 설정한 청크 사이즈가 적절한지 육안 확인
- **내용**: 처음 5개 청크의 내용, 글자 수 표시

### 2.6 청킹 전략 선택 (NEW)

```text
┌─ 청킹 전략 ──────────────────────────────────────────┐
│                                                      │
│  ○ 토큰 기반 (기본)                                  │
│     └ 고정 토큰 수로 분리 / 빠름 / 무료              │
│                                                      │
│  ◉ 시맨틱 (AI 기반) ← 추천                          │
│     └ LLM이 논리 단위로 분리 / 정밀함                │
│                                                      │
│  ○ 구조 기반                                         │
│     └ 헤딩/번호 인식하여 분리 / 사전·주석에 적합     │
│                                                      │
└──────────────────────────────────────────────────────┘
```

#### 💡 Dual-Mode 전략 (비용 정책)

| 실행 환경 | 시맨틱 청킹 방식 | 비용 |
|----------|-----------------|------|
| **Streamlit (배포용)** | 별도 API 호출 | 💰 유료 (~$0.02/책) |
| **IDE (Antigravity 등)** | 세션 컨텍스트 활용 | ✅ **무료** |

> **개발자 모드**: IDE 환경에서 직접 청킹 작업 시, LLM 세션 토큰 내에서 처리되므로 추가 API 비용 없음.  
> **배포용 모드**: 일반 사용자는 토큰 기반(무료) 또는 API 키 입력 후 시맨틱(유료) 선택 가능.

### 2.7 저장 JSON 구조 (archive/)

```json
{
  "source": "Michael Welker - In God's Image (2021).epub",
  "metadata": {
    "author": "Michael Welker",
    "title": "In God's Image",
    "year": 2021,
    "doc_type": "dogmatics",
    "languages": ["en"],
    "field": "systematic_theology",
    "tags": ["anthropology", "imago_dei", "pneumatology"],
    "chunk_strategy": "semantic",
    "chunk_size": 1200,
    "chunk_overlap": 150
  },
  "indexed_at": "2026-01-11T10:25:00",
  "total_chunks": 107,
  "chunks": [
    {
      "content": "...",
      "metadata": {
        "source": "...",
        "author": "Michael Welker",
        "doc_type": "dogmatics",
        "tags": ["anthropology", "imago_dei"],
        "page": 1,
        "chunk_index": 0,
        "start_index": 0
      }
    }
  ]
}
```

---

## 🔷 3단계: 임베딩 (배치 진행률)

### 3.1 UI 디자인

```text
┌─────────────────────────────────────────────────────────────┐
│ 🚀 임베딩 진행 중...                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ [███████████████████░░░░░░░░░░░░░░░░░░░░] 47%              │
│                                                             │
│ 현재: Michael Welker - In God's Image                       │
│ 배치: 12 / 27 (batch_size=4, MPS 최적화)                   │
│ 청크: 48 / 107                                              │
│ 예상 잔여 시간: ~2분 30초                                    │
│                                                             │
│ ────────────────────────────────────────                   │
│ ✅ 완료: Barth_KD_I_1.pdf (523 청크 inserted)               │
│ ⏳ 진행: Michael Welker - In God's Image (48/107)           │
│ ⏸️ 대기: TDNT_Vol1.pdf                                      │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 기술적 구현사항
- **MPS (Apple Silicon) 최적화**: `batch_size=4` 강제 적용
- **진행률 계산**: `(현재 배치 / 총 배치) * 100`
- **실시간 피드백**: `yield` 제너레이터 패턴 사용하여 Streamlit에 실시간 로그 전송

---

## 🔷 4단계: 완료 대시보드 (NEW)

### 4.1 UI 디자인

```text
┌─────────────────────────────────────────────────────────────┐
│ ✅ 인덱싱 완료!                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 이번 세션 요약                                          │
│  ─────────────────────────────────────                     │
│  처리된 파일:    3개                                        │
│  총 청크 수:     1,247개                                    │
│  DB 용량 변화:   +156 MB (총 2.3 GB)                        │
│  소요 시간:      12분 43초                                  │
│                                                             │
│  📁 파일별 상세                                             │
│  ─────────────────────────────────────                     │
│  ├─ Barth_KD_I_1.pdf         523 청크  (교의학)            │
│  ├─ Michael Welker...epub    107 청크  (교의학)            │
│  └─ TDNT_Vol1.pdf            617 청크  (사전)              │
│                                                             │
│  🏷️ 적용된 태그: anthropology, imago_dei, justification    │
│                                                             │
│  [상세 로그 보기] [DB 통계 보기] [새 작업 시작]             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 제공 정보
- **세션 요약**: 처리 파일 수, 총 청크 수, DB 용량 변화, 소요 시간
- **파일별 상세**: 각 파일의 청크 수 및 도서 유형
- **태그 요약**: 이번 세션에서 사용된 주제 태그 목록
- **액션 버튼**: 상세 로그, DB 통계, 새 작업 시작

---

## � 5단계: 검색 전략 (NEW)

### 5.1 이중 검색 (Dual Search) - 기본값

```text
[사용자 쿼리]
       ↓
┌──────────────────────────────────────────────────────┐
│                  이중 검색 엔진                        │
├──────────────────────────────────────────────────────┤
│                                                      │
│  [Vector DB 검색]          [Archive JSON 검색]        │
│  ├─ 시맨틱 유사도          ├─ 키워드 정확 매칭        │
│  ├─ BGE-M3 임베딩          ├─ 메타데이터 필터         │
│  └─ 넓은 그물 🌐            └─ 촘촘한 그물 🔍          │
│                                                      │
│              ↓         결과 병합         ↓            │
│         ┌─────────────────────────────────┐          │
│         │  중복 제거 + 관련도 재순위화     │          │
│         └─────────────────────────────────┘          │
└──────────────────────────────────────────────────────┘
```

### 5.2 3중 언어 쿼리 확장 (Trilingual Query Expansion)

```text
[사용자 쿼리]        [쿼리 확장 (자동)]
     ↓                    ↓
  "칭의론"    →    ├─ 한: "칭의", "의롭다함", "칭의론"
                   ├─ 영: "Justification", "Righteousness"
                   └─ 독: "Rechtfertigung", "Rechtfertigungslehre"
```

#### 💡 BGE-M3 모델 특성

| 항목 | 수치 | 설명 |
|------|------|------|
| **다국어 지원** | 100+ 언어 | 한/영/독 모두 최상급 |
| **단일 언어 검색 시** | ~80% 커버 | 다른 언어 문서도 검색됨 |
| **쿼리 확장 추가 시** | ~95% 커버 | 전문 용어까지 커버 |
| **이중 검색 추가 시** | ~99% 커버 | 사실상 누락 없음 |

### 5.3 검색 UI 디자인

```text
┌─────────────────────────────────────────────────────────────┐
│ 🔍 검색                                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  검색어: [칭의론                              ] [검색 🔍]   │
│                                                             │
│  ───── 검색 옵션 ─────                                      │
│  ☑ 이중 검색 (Vector + JSON)     ← 기본 활성화             │
│  ☑ 3중 언어 확장 (한/영/독)      ← 기본 활성화             │
│                                                             │
│  ───── 필터 ─────                                           │
│  도서 유형: ☐ 교의학  ☐ 사전  ☐ 주석  ☐ 전체             │
│  주제 태그: [칭의] [바르트] [+추가]                         │
│                                                             │
│  ───── 검색 결과 (23건) ─────                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📖 Barth_KD_IV_1.pdf (교의학)                        │   │
│  │ "Die Rechtfertigung des Sünders..."                  │   │
│  │ 관련도: ████████░░ 85% | 페이지: 523 | [상세보기]     │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📚 TDNT Vol.2 (사전)                                 │   │
│  │ "δικαιοσύνη (dikaiosyne) - Righteousness..."         │   │
│  │ 관련도: ████████░░ 82% | 항목: δικ- | [상세보기]     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 기술적 구현

```python
# 검색 흐름 (의사코드)
def dual_search(query: str, expand_trilingual: bool = True):
    # 1. 쿼리 확장 (한/영/독)
    if expand_trilingual:
        expanded = expand_query_trilingual(query)  # LLM 활용
    else:
        expanded = [query]
    
    # 2. Vector DB 검색
    vector_results = chromadb.query(
        query_embeddings=embed(expanded),
        n_results=20
    )
    
    # 3. Archive JSON 검색 (키워드 매칭)
    json_results = search_archive_json(
        keywords=expanded,
        metadata_filter=user_filters
    )
    
    # 4. 결과 병합 & 중복 제거
    merged = merge_and_dedupe(vector_results, json_results)
    
    return rerank(merged)  # 관련도 재순위화
```

---

## 📁 파일 변경 목록

| 파일 | 변경 내용 |
|------|----------|
| `app.py` | 2단계 메타데이터 입력 폼, 3~4단계 UI, 5단계 검색 UI 구현 |
| `processor_v4.py` | 청킹/임베딩 로직 분리, 배치 처리 시 `yield` 추가 |
| `pipeline/router.py` | 파일명 파싱 로직(Regex) 고도화 |
| `pipeline/chunker.py` | 확장된 메타데이터(tags) 주입 로직 추가 |
| `pipeline/metadata_parser.py` | (신규) 파일명 기반 메타데이터 추출 모듈 |
| `pipeline/semantic_chunker.py` | (신규) LLM 기반 시맨틱 청킹 모듈 |
| `utils/dual_search.py` | (신규) 이중 검색 엔진 (Vector + JSON) |
| `utils/query_expander.py` | (신규) 3중 언어 쿼리 확장 모듈 |

---

## ⏱️ 예상 작업량

| 항목 | 예상 시간 |
|------|----------|
| 1. 메타데이터 파서 및 UI 구현 (태그 포함) | 35분 |
| 2. 파일명 파싱 로직 구현 | 15분 |
| 3. 시맨틱 청킹 모듈 구현 | 25분 |
| 4. 임베딩 배치 처리 및 진행률 표시 | 10분 |
| 5. 완료 대시보드 UI 구현 | 15분 |
| 6. 이중 검색 엔진 구현 | 20분 |
| 7. 쿼리 확장 모듈 구현 | 15분 |
| 8. 전체 통합 테스트 및 디버깅 | 25분 |
| **총 합계** | **약 160분 (2시간 40분)** |

